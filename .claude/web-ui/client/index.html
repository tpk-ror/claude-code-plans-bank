<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Plans</title>

  <!-- xterm.js from CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">

  <!-- Custom styles -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/terminal.css">
</head>
<body class="dark-mode">
  <!-- Loading Overlay with Status -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div id="loadingStatus" class="loading-status">Initializing...</div>
      <div class="loading-steps">
        <div id="step-scripts" class="loading-step">Loading scripts...</div>
        <div id="step-websocket" class="loading-step">Connecting WebSocket...</div>
        <div id="step-terminal" class="loading-step">Initializing terminal...</div>
        <div id="step-plans" class="loading-step">Loading plans...</div>
      </div>
    </div>
  </div>

  <div id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1 class="logo">Claude Code Plans</h1>
      </div>
      <div class="header-center">
        <span class="sync-status" id="syncStatus">
          <span class="status-dot connected"></span>
          <span class="status-text">Connected</span>
        </span>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" id="newPlanBtn">
          <span class="btn-icon">+</span> New Plan
        </button>
        <button class="btn btn-icon-only" id="themeToggle" title="Toggle theme">
          <span class="theme-icon">☀</span>
        </button>
      </div>
    </header>

    <!-- Main content area -->
    <div class="main-container">
      <!-- Sidebar with plans list -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>Plans</h2>
          <div style="display: flex; gap: 4px;">
            <button class="btn btn-sm btn-ghost" id="syncPlansBtn" title="Sync plans from Claude">
              ↻
            </button>
            <button class="btn btn-sm btn-ghost" id="sidebarToggle" title="Toggle sidebar">
              ◀
            </button>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <select id="statusFilter" class="filter-select">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
          <select id="categoryFilter" class="filter-select">
            <option value="">All Categories</option>
            <option value="feature">Feature</option>
            <option value="bugfix">Bugfix</option>
            <option value="refactor">Refactor</option>
            <option value="docs">Docs</option>
            <option value="test">Test</option>
            <option value="chore">Chore</option>
          </select>
          <input type="search" id="searchFilter" class="filter-input" placeholder="Search plans...">
        </div>

        <!-- Plans list -->
        <div class="plans-list" id="plansList">
          <div class="plans-loading">Loading plans...</div>
        </div>
      </aside>

      <!-- Main content: Terminal + Plan detail -->
      <main class="main-content">
        <!-- Terminal area -->
        <div class="terminal-container" id="terminalContainer">
          <div class="terminal-header">
            <span class="terminal-title">Terminal</span>
            <div class="terminal-actions">
              <button class="btn btn-sm btn-ghost" id="newSessionBtn" title="New session">
                + New
              </button>
              <button class="btn btn-sm btn-ghost" id="killSessionBtn" title="End session" disabled>
                ✕ End
              </button>
            </div>
          </div>
          <div class="terminal-wrapper" id="terminalWrapper">
            <div id="terminal"></div>
            <div class="terminal-placeholder" id="terminalPlaceholder">
              <p>No active session</p>
              <button class="btn btn-primary" id="startSessionBtn">Start Claude Session</button>
            </div>
          </div>
        </div>

        <!-- Plan detail panel (collapsible) -->
        <div class="plan-detail-panel collapsed" id="planDetailPanel">
          <div class="panel-header">
            <h3 class="panel-title" id="planDetailTitle">Select a plan</h3>
            <button class="btn btn-sm btn-ghost" id="closePanelBtn">✕</button>
          </div>
          <div class="panel-content" id="planDetailContent">
            <p class="empty-state">Select a plan from the sidebar to view details</p>
          </div>
        </div>
      </main>
    </div>

    <!-- New Plan Modal -->
    <div class="modal hidden" id="newPlanModal">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Plan</h3>
          <button class="btn btn-sm btn-ghost modal-close" id="closeNewPlanModal">✕</button>
        </div>
        <form id="newPlanForm" class="modal-body">
          <div class="form-group">
            <label for="planTitle">Title</label>
            <input type="text" id="planTitle" required placeholder="e.g., Add user authentication">
          </div>
          <div class="form-group">
            <label for="planCategory">Category</label>
            <select id="planCategory">
              <option value="feature">Feature</option>
              <option value="bugfix">Bugfix</option>
              <option value="refactor">Refactor</option>
              <option value="docs">Documentation</option>
              <option value="test">Test</option>
              <option value="chore">Chore</option>
            </select>
          </div>
          <div class="form-group">
            <label for="planDescription">Description (optional)</label>
            <textarea id="planDescription" rows="3" placeholder="Brief description of the plan"></textarea>
          </div>
          <div class="form-group">
            <label for="planPriority">Priority</label>
            <select id="planPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-ghost" id="cancelNewPlan">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Plan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal hidden" id="addNoteModal">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-sm">
        <div class="modal-header">
          <h3>Add Note</h3>
          <button class="btn btn-sm btn-ghost modal-close" id="closeAddNoteModal">✕</button>
        </div>
        <form id="addNoteForm" class="modal-body">
          <div class="form-group">
            <label for="noteContent">Note</label>
            <textarea id="noteContent" rows="4" required placeholder="Enter your note..."></textarea>
          </div>
          <input type="hidden" id="noteFilename">
          <div class="form-actions">
            <button type="button" class="btn btn-ghost" id="cancelAddNote">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Note</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="keyboard-help hidden" id="keyboardHelp">
      <h4>Keyboard Shortcuts</h4>
      <ul>
        <li><kbd>Ctrl</kbd>+<kbd>N</kbd> New Plan</li>
        <li><kbd>Escape</kbd> Focus Terminal</li>
        <li><kbd>Ctrl</kbd>+<kbd>B</kbd> Toggle Sidebar</li>
        <li><kbd>?</kbd> Show Help</li>
      </ul>
    </div>
  </div>

  <!-- Early loading status script -->
  <script>
    // Track script loading for debugging
    window.scriptLoadStatus = {};
    window.updateLoadingStep = function(stepId, status, message) {
      var step = document.getElementById('step-' + stepId);
      if (step) {
        step.className = 'loading-step ' + status;
        if (message) step.textContent = message;
      }
    };
    window.updateLoadingStatus = function(message, isError) {
      var el = document.getElementById('loadingStatus');
      if (el) {
        el.textContent = message;
        el.className = isError ? 'loading-status error' : 'loading-status';
      }
      console.log('[Loader] ' + message);
    };

    // Set timeout to detect hung loading
    window.loadingTimeout = setTimeout(function() {
      console.error('[Loader] Loading timeout - checking status...');
      var status = window.scriptLoadStatus;
      var missing = [];
      if (!status.xterm) missing.push('xterm.js');
      if (!status.xtermFit) missing.push('xterm-addon-fit.js');
      if (!status.websocket) missing.push('websocket.js');
      if (!status.terminal) missing.push('terminal.js');
      if (!status.plans) missing.push('plans.js');
      if (!status.app) missing.push('app.js');

      if (missing.length > 0) {
        window.updateLoadingStatus('Failed to load: ' + missing.join(', '), true);
        window.updateLoadingStep('scripts', 'error', 'Script load failed: ' + missing.join(', '));
      }
    }, 15000);
  </script>

  <!-- Scripts with load tracking -->
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"
          onload="window.scriptLoadStatus.xterm=true; console.log('[Loader] xterm loaded')"
          onerror="window.updateLoadingStatus('Failed to load xterm.js from CDN', true); window.updateLoadingStep('scripts', 'error', 'xterm.js CDN failed')"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"
          onload="window.scriptLoadStatus.xtermFit=true; console.log('[Loader] xterm-fit loaded')"
          onerror="window.updateLoadingStatus('Failed to load xterm-addon-fit.js from CDN', true); window.updateLoadingStep('scripts', 'error', 'xterm-fit CDN failed')"></script>
  <script src="js/websocket.js"
          onload="window.scriptLoadStatus.websocket=true; console.log('[Loader] websocket.js loaded')"
          onerror="window.updateLoadingStatus('Failed to load websocket.js', true)"></script>
  <script src="js/terminal.js"
          onload="window.scriptLoadStatus.terminal=true; console.log('[Loader] terminal.js loaded')"
          onerror="window.updateLoadingStatus('Failed to load terminal.js', true)"></script>
  <script src="js/plans.js"
          onload="window.scriptLoadStatus.plans=true; console.log('[Loader] plans.js loaded')"
          onerror="window.updateLoadingStatus('Failed to load plans.js', true)"></script>
  <script src="js/app.js"
          onload="window.scriptLoadStatus.app=true; clearTimeout(window.loadingTimeout); console.log('[Loader] app.js loaded - all scripts ready')"
          onerror="window.updateLoadingStatus('Failed to load app.js', true)"></script>
</body>
</html>
